<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pomodoro Timer — PWA-ready</title>
  <meta name="description" content="Pomodoro timer: 25/5/15, responsive, installable PWA, notifications & offline" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23ff6b6b' /%3E%3C/text%3E%3C/svg%3E">
  <style>
    :root{ --bg:#0f1724; --card:#0b1220; --accent:#ff6b6b; --muted:#94a3b8; --glass: rgba(255,255,255,0.04)}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;color:#e6eef8;background:linear-gradient(180deg,#071021 0%, #071827 60%);}
    .app{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:32px}
    .card{width:100%;max-width:820px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:16px;padding:24px;box-shadow:0 8px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03);display:grid;grid-template-columns:320px 1fr;gap:20px}
    @media(max-width:820px){.card{grid-template-columns:1fr;padding:18px}}
    .left{display:flex;flex-direction:column;align-items:center;gap:18px}
    .clock{width:260px;height:260px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:radial-gradient(circle at 30% 10%, rgba(255,255,255,0.02), transparent 30%), var(--glass);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,0.03)}
    .time{font-size:48px;font-weight:700;letter-spacing:1px}
    .label{font-size:14px;color:var(--muted);margin-top:6px}
    .controls{display:flex;gap:12px;margin-top:8px}
    button{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:10px 14px;border-radius:10px;color:inherit;font-weight:600;cursor:pointer}
    button.primary{background:linear-gradient(90deg,var(--accent),#ff8b8b);border:none;color:#081226}
    .right{display:flex;flex-direction:column;gap:12px}
    .row{display:flex;gap:12px;align-items:center}
    .settings{padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border:1px solid rgba(255,255,255,0.02)}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input[type=range]{width:100%}
    .small{font-size:13px;color:var(--muted)}
    .session-count{font-weight:700;font-size:14px}
    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:6px;color:var(--muted);font-size:13px}
    .btn-ghost{background:transparent;border:1px dashed rgba(255,255,255,0.04);padding:8px;border-radius:10px}
    .toggle{display:inline-flex;align-items:center;gap:10px}
    .accent{color:var(--accent)}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <main class="app">
    <section class="card" role="application" aria-label="Pomodoro Timer">
      <div class="left">
        <div class="clock" id="clock" aria-live="polite">
          <div class="time" id="time">25:00</div>
          <div class="label" id="modeLabel">Work • Pomodoro</div>
        </div>

        <div class="controls">
          <button id="startBtn" class="primary">Start</button>
          <button id="pauseBtn">Pause</button>
          <button id="resetBtn" class="btn-ghost">Reset</button>
          <button id="installBtn" class="btn-ghost" style="display:none">Install</button>
        </div>

        <div class="footer">
          <div class="small">Completed: <span id="completed">0</span></div>
          <div class="small">Auto-switch: <span id="autoSwitchLabel">On</span></div>
        </div>
      </div>

      <div class="right">
        <div class="settings">
          <div class="row">
            <div style="flex:1">
              <label for="workMinutes">Work (minutes)</label>
              <input id="workMinutes" type="number" min="1" max="120" value="25">
            </div>
            <div style="flex:1">
              <label for="shortBreak">Short Break (minutes)</label>
              <input id="shortBreak" type="number" min="1" max="60" value="5">
            </div>
            <div style="flex:1">
              <label for="longBreak">Long Break (minutes)</label>
              <input id="longBreak" type="number" min="5" max="60" value="15">
            </div>
          </div>

          <div style="margin-top:12px" class="row">
            <div style="flex:1">
              <label for="autoSwitch">Auto switch to next session</label>
              <select id="autoSwitch">
                <option value="true">On</option>
                <option value="false">Off</option>
              </select>
            </div>
            <div style="flex:1">
              <label for="longAfter">Long break after how many pomodoros?</label>
              <input id="longAfter" type="number" min="1" max="10" value="4">
            </div>
            <div style="flex:1">
              <label for="soundToggle">Sound & Notification</label>
              <select id="soundToggle"><option value="true">On</option><option value="false">Off</option></select>
            </div>
          </div>

          <div style="margin-top:12px" class="row">
            <button id="saveSettings">Save</button>
            <button id="resetSettings" class="btn-ghost">Reset Settings</button>
            <button id="notifyTest" class="btn-ghost">Test Notify</button>
          </div>

        </div>

        <div style="margin-top:12px" class="settings">
          <div class="row"><div style="flex:1"><label>Theme</label><div class="row"><button id="themeLight" class="btn-ghost">Light</button><button id="themeDark" class="btn-ghost">Dark</button></div></div></div>
          <div style="margin-top:8px" class="row"><div style="flex:1"><label>Reset App Data</label><button id="clearData" class="btn-ghost">Clear</button></div></div>
        </div>

        <div style="margin-top:12px" class="small">Tips: Pomodoro = 25 min focus, 5 min short break. After 4 pomodoros, take a longer break.</div>
      </div>

    </section>
  </main>

<script>
// Basic pomodoro logic with PWA-ready manifest & service worker created dynamically
(() => {
  const defaultSettings = { work:25, short:5, long:15, longAfter:4, autoSwitch:true, sound:true };
  const el = id=>document.getElementById(id);
  const timeEl = el('time');
  const modeLabel = el('modeLabel');
  const startBtn = el('startBtn');
  const pauseBtn = el('pauseBtn');
  const resetBtn = el('resetBtn');
  const installBtn = el('installBtn');
  const completedEl = el('completed');
  const autoSwitchLabel = el('autoSwitchLabel');

  // settings inputs
  const inWork = el('workMinutes');
  const inShort = el('shortBreak');
  const inLong = el('longBreak');
  const inAuto = el('autoSwitch');
  const inLongAfter = el('longAfter');
  const inSound = el('soundToggle');
  const saveSettings = el('saveSettings');
  const resetSettings = el('resetSettings');
  const notifyTest = el('notifyTest');
  const clearData = el('clearData');

  let settings = load('pom_settings') || defaultSettings;
  applySettingsToInputs();

  let state = load('pom_state') || { mode:'work', remaining: settings.work*60, running:false, completed:0, cycle:0 };
  let timerInterval = null;

  function applySettingsToInputs(){
    inWork.value = settings.work; inShort.value = settings.short; inLong.value = settings.long; inLongAfter.value = settings.longAfter; inAuto.value = settings.autoSwitch; inSound.value = settings.sound;
  }

  function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
  function load(key){ try{ return JSON.parse(localStorage.getItem(key)); }catch(e){return null;} }

  function formatTime(s){ const m = Math.floor(s/60).toString().padStart(2,'0'); const sec = (s%60).toString().padStart(2,'0'); return `${m}:${sec}` }

  function render(){
    timeEl.textContent = formatTime(state.remaining);
    modeLabel.textContent = state.mode === 'work' ? 'Work • Pomodoro' : (state.mode === 'short' ? 'Short Break' : 'Long Break');
    completedEl.textContent = state.completed;
    autoSwitchLabel.textContent = settings.autoSwitch ? 'On' : 'Off';
    // buttons
    startBtn.disabled = state.running;
    pauseBtn.disabled = !state.running;
  }

  function startTimer(){ if(state.running) return; state.running = true; save('pom_state', state); timerTick(); timerInterval = setInterval(timerTick, 1000); }
  function pauseTimer(){ state.running = false; clearInterval(timerInterval); save('pom_state', state); }
  function resetTimer(full=false){ clearInterval(timerInterval); state.running=false; state.mode='work'; state.cycle=0; state.completed=0; state.remaining = settings.work*60; if(full){ localStorage.removeItem('pom_state'); } save('pom_state', state); render(); }

  function timerTick(){ if(state.remaining>0){ state.remaining--; save('pom_state', state); render(); } else { // session ended
      notifyEndOfSession();
      if(state.mode==='work'){ state.completed++; state.cycle++; }
      // decide next
      if(settings.autoSwitch){ if(state.mode==='work'){
            if(state.cycle % settings.longAfter === 0){ state.mode='long'; state.remaining = settings.long*60; }
            else { state.mode='short'; state.remaining = settings.short*60; }
          } else { state.mode='work'; state.remaining = settings.work*60; }
          // continue running
      } else {
        state.running=false; clearInterval(timerInterval);
      }
      save('pom_state', state);
      render();
    } }

  function notifyEndOfSession(){ if(settings.sound){ playBeep(); }
    if('Notification' in window && Notification.permission === 'granted'){
      const text = state.mode==='work' ? 'Sesi kerja selesai — ambil istirahat' : 'Istirahat selesai — kembali kerja';
      new Notification('Pomodoro', { body: text, vibrate:[200,100,200] });
    }
    // basic vibration
    if('vibrate' in navigator) navigator.vibrate([200,100,200]);
  }

  function playBeep(){ try{ const ctx = new (window.AudioContext || window.webkitAudioContext)(); const o = ctx.createOscillator(); const g = ctx.createGain(); o.type='sine'; o.frequency.value = 880; g.gain.value = 0.03; o.connect(g); g.connect(ctx.destination); o.start(); setTimeout(()=>{ o.stop(); ctx.close(); }, 400); }catch(e){}
  }

  // UI events
  startBtn.addEventListener('click', ()=>{ startTimer(); });
  pauseBtn.addEventListener('click', ()=>{ pauseTimer(); });
  resetBtn.addEventListener('click', ()=>{ resetTimer(true); });

  saveSettings.addEventListener('click', ()=>{
    settings.work = Math.max(1, parseInt(inWork.value)||25);
    settings.short = Math.max(1, parseInt(inShort.value)||5);
    settings.long = Math.max(1, parseInt(inLong.value)||15);
    settings.longAfter = Math.max(1, parseInt(inLongAfter.value)||4);
    settings.autoSwitch = inAuto.value === 'true';
    settings.sound = inSound.value === 'true';
    save('pom_settings', settings);
    // apply to running state (only affects next session)
    if(!state.running){ if(state.mode==='work') state.remaining = settings.work*60; else if(state.mode==='short') state.remaining = settings.short*60; else state.remaining = settings.long*60; save('pom_state', state); }
    applySettingsToInputs(); render();
    alert('Settings disimpan.');
  });

  resetSettings.addEventListener('click', ()=>{
    if(confirm('Kembalikan ke pengaturan default?')){ settings = defaultSettings; save('pom_settings', settings); applySettingsToInputs(); if(!state.running){ state.remaining = settings.work*60; save('pom_state', state); } render(); }
  });

  notifyTest.addEventListener('click', async ()=>{
    if('Notification' in window){ if(Notification.permission !== 'granted'){ await Notification.requestPermission(); }
      if(Notification.permission === 'granted'){ new Notification('Test Notifikasi', { body:'Ini notifikasi test dari Pomodoro' }); } else alert('Notifikasi tidak diizinkan'); }
  });

  clearData.addEventListener('click', ()=>{
    if(confirm('Hapus data aplikasi (settings & state)?')){ localStorage.removeItem('pom_settings'); localStorage.removeItem('pom_state'); settings = defaultSettings; state = { mode:'work', remaining:settings.work*60, running:false, completed:0, cycle:0 }; applySettingsToInputs(); render(); alert('Data dihapus'); }
  });

  // Theme buttons (simple)
  el('themeLight').addEventListener('click', ()=>{ document.documentElement.style.setProperty('--bg','#f8fafc'); document.documentElement.style.setProperty('--card','#ffffff'); document.documentElement.style.setProperty('--accent','#ff6b6b'); document.body.style.color='#052020'; });
  el('themeDark').addEventListener('click', ()=>{ document.documentElement.style.setProperty('--bg','#071021'); document.documentElement.style.setProperty('--card','#0b1220'); document.body.style.color=''; });

  // install PWA handler
  let deferredPrompt = null;
  window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; installBtn.style.display='inline-block'; });
  installBtn.addEventListener('click', async ()=>{ if(deferredPrompt){ deferredPrompt.prompt(); const choice = await deferredPrompt.userChoice; deferredPrompt = null; installBtn.style.display='none'; } });

  // Request Notification permission early
  if('Notification' in window && Notification.permission === 'default'){
    // do not annoy; ask only after user interacts (we show a small hint via Test Notify)
  }

  // Persist settings & state
  function initFromStorage(){ const s = load('pom_settings'); if(s) settings = Object.assign(settings, s); const st = load('pom_state'); if(st) state = Object.assign(state, st); }
  initFromStorage(); render();

  // If user has no state, set initial remaining
  if(!state || typeof state.remaining !== 'number'){ state = { mode:'work', remaining: settings.work*60, running:false, completed:0, cycle:0 }; }

  // create manifest and service worker dynamically so single-file app is PWA-ready
  function createAndAttachManifest(){ const manifest = { name:'Pomodoro Timer', short_name:'Pomodoro', start_url:'.', display:'standalone', background_color:'#071021', theme_color:'#ff6b6b', icons:[{src:'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Ccircle cx="50" cy="50" r="45" fill="%23ff6b6b"/%3E%3C/svg%3E', sizes:'192x192', type:'image/svg+xml'}] };
    const blob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const link = document.createElement('link'); link.rel='manifest'; link.href = url; document.head.appendChild(link);
  }

  function createAndRegisterServiceWorker(){
    if(!('serviceWorker' in navigator)) return;
    const sw = `self.addEventListener('install', event => { self.skipWaiting(); event.waitUntil(caches.open('pom-cache-v1').then(cache => cache.addAll(['./','./?source=pwa']))); });
    self.addEventListener('activate', event => { event.waitUntil(self.clients.claim()); });
    self.addEventListener('fetch', event => { event.respondWith(caches.match(event.request).then(resp => resp || fetch(event.request).then(fetchResp => { return caches.open('pom-cache-v1').then(cache=>{ try{ cache.put(event.request, fetchResp.clone()); }catch(e){} return fetchResp; }); }))); });`;
    const blob = new Blob([sw], {type:'text/javascript'});
    const swUrl = URL.createObjectURL(blob);
    navigator.serviceWorker.register(swUrl).then(reg => console.log('SW registered (blob) ->', reg.scope)).catch(err => console.warn('SW reg failed', err));
  }

  createAndAttachManifest(); createAndRegisterServiceWorker();

  // show initial render
  render();

  // Expose a little API for debugging in console
  window.__pom = { state, settings, start: startTimer, pause: pauseTimer, reset: ()=>resetTimer(true) };

})();
</script>
</body>
</html>
